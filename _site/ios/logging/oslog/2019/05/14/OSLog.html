<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Heva Wu's Blog - iOS Logging System -- OSLog</title>
    <meta name="viewport" content="width=device-width">

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

    <!-- Responsive CSS -->
    <link rel="stylesheet" href="/css/responsive.css">

    <!-- Google Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Raleway:300,400,700' rel='stylesheet' type='text/css'>
</head>

<body>
  <div class="site">
    <div class="sidebar" id="sidebar">
      <div class="header">
        <h1 class="title"><a href="/about" ><img id="logo" src="/images/logo.png"></a></h1>
        <span class="tagline">Heva Wu's Blog</span>
        <span class="motto">I may not be there yet, but I'm closer than I was yesterday. </span>
        <span class="motto">(￣︶￣)↗[GO!]</span>
      </div>
      <div class="sidebar-info">
        <ul class="sidebar-info-list">
          <li class="sidebar-info-link">
              <a href="/blog/tags" class="">Tags</a>
          </li>
          <li>
              <a href="/blog/categories" class="">Categories</a>
          </li>
          <li>
              <a href="/blog.html" class="footer-link">Latest Blog</a>
          </li>
        </ul>
      </div>
      <div class="footer">
        <span id="footer-links">
          <a href="/about" class="footer-link">About</a> <span class="separator">&bull;</span>
          <a href="https://www.linkedin.com/in/he-heva-wu-2a6819113/" class="footer-link">LinkedIn</a> <span class="separator">&bull;</span>
          <a href="https://github.com/HevaWu" class="footer-link">GitHub</a>
        </span>
      </div>
    </div>

    <div class="content" id="home">
  <div id="sidebar-button">
    <img src="/images/sidebar-button.png">
  </div>

  <div id="post-info">
    <div id="cover-photo-container">
      
    </div>
    <div id="info-container">
      <h1 id="title">iOS Logging System -- OSLog</h1>
      <time datetime="2019-05-14T01:04:00+09:00" itemprop="datePublished">
        May 14, 2019
      </time>
      <div id="tag-category-container">
           
          
          <a href="/blog/tags/#ios" class="post-tag">iOS</a>
          
          <a href="/blog/tags/#logging" class="post-tag">Logging</a>
          
          <a href="/blog/tags/#oslog" class="post-tag">OSLog</a>
          
          <a href="/blog/tags/#os" class="post-tag">OS</a>
          
          
          <p></p>
           
          
          <a href="/blog/categories/#ios" class="post-category">iOS</a>
          
          <a href="/blog/categories/#logging" class="post-category">Logging</a>
          
          <a href="/blog/categories/#oslog" class="post-category">OSLog</a>
          
          
      </div>
    </div>
  </div>

  <div class="post">
    <p>This article is introducing the <code class="highlighter-rouge">Unified Logging</code> system and how to use it to measure performace.</p>

<h1 id="unified-logging">Unified Logging</h1>
<p>From the document:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The unified logging system provides a single, efficient,
 performant API for capturing messaging across all levels
 of the system.
</code></pre></div></div>

<p>The Unified Logging uses Activity Tracing for performance, consolicates kernel and user-space logging.</p>

<h2 id="why-using-it">Why using it</h2>
<ul>
  <li>Compressing data</li>
  <li>Deferring work and data collection</li>
  <li>Managing log message lifecycle</li>
</ul>

<p>We want as much logging on all the time as possible.</p>

<h2 id="key-features">Key Features</h2>
<ul>
  <li>Improved categorization and filtering of log messages</li>
  <li>Logging system collects caller information</li>
  <li>New Builtin type specifiers - simplifies log message preparation</li>
  <li>New Console application and command-line tool (graph)</li>
  <li>Supported on macOS, iOS, tvOS, watchOS and Simulators</li>
  <li>Support for Objective C, C++, C and Swift</li>
</ul>

<h2 id="logging-concepts">Logging Concepts</h2>

<h3 id="adption">Adption</h3>
<ul>
  <li>Build with the macOS 10.12, iOS 10.0 or watchOS 3.0 SDK</li>
  <li>Legacy APIs(NSLog, as_log_message, syslog…) redirected into new system</li>
  <li>Log data will be in new format and location</li>
</ul>

<h3 id="new-file-formats">New File Formats</h3>
<ul>
  <li>Log data is kept in a compressed binary format: <code class="highlighter-rouge">.tracev3</code> files</li>
  <li>Stored under <code class="highlighter-rouge">/var/db/diagnostics</code> with support in <code class="highlighter-rouge">/var/db/uuidtext</code></li>
  <li><code class="highlighter-rouge">.logarchive</code> format for portability of logs (collection of log data, easier to transfer to email or …)</li>
</ul>

<h3 id="subsystems-and-categories">Subsystems and Categories</h3>
<ul>
  <li>Log messages can be associated with a subsystem and category</li>
  <li>Can be used to control how log messages are fitered and displayed</li>
  <li>A subsystem can contain multiple categories</li>
</ul>

<p>Your application will have own subsystems and categories as needed.</p>

<h3 id="logging-behavior">Logging Behavior</h3>
<p>Each log message has a level determined by the API used</p>
<ul>
  <li>Three basic levels – Default, Info, Debug</li>
  <li>Two special levels – Fault, Error</li>
</ul>

<p>Each basic levels has two characteristics that can be set for system, subsystem, or category</p>
<ul>
  <li>Need to check if it is enabled (Default messages are always enabled)</li>
  <li>Is it stored to disk or memory? (Fault or Error are always stored to disk.)</li>
</ul>

<p>The levels are hierarchical</p>
<ul>
  <li>Setting Debug to go to disk implies that Info will also go to disk</li>
</ul>

<p>Behavior can be customized by installing profiles or, on macOS, via log command</p>

<h3 id="standard-behavior">Standard Behavior</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Message Level</th>
      <th style="text-align: left">Enabled</th>
      <th style="text-align: left">Destination</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">DEFAULT LEVEL</td>
      <td style="text-align: left">ALWAYS</td>
      <td style="text-align: left">DISK</td>
    </tr>
    <tr>
      <td style="text-align: left">INFO LEVEL</td>
      <td style="text-align: left">YES</td>
      <td style="text-align: left">MEMORY</td>
    </tr>
    <tr>
      <td style="text-align: left">DEBUG LEVEL</td>
      <td style="text-align: left">NO</td>
      <td style="text-align: left">N/A</td>
    </tr>
    <tr>
      <td style="text-align: left">ERROR</td>
      <td style="text-align: left">ALWAYS</td>
      <td style="text-align: left">DISK</td>
    </tr>
    <tr>
      <td style="text-align: left">FAULT</td>
      <td style="text-align: left">ALWAYS</td>
      <td style="text-align: left">DISK</td>
    </tr>
  </tbody>
</table>

<h3 id="privacy">Privacy</h3>
<p>Prevent accidental logging of Personally Identifiable Information(PII)</p>

<h3 id="faults-and-errors">Faults and Errors</h3>
<ul>
  <li>Errors – represent issues discovered within a given application/library</li>
  <li>Faults – represent more global problems in the system</li>
  <li>Faults and Error log information is captured into a seperate set of log files (They will exsit longer than normal logs)</li>
</ul>

<h3 id="architecture">Architecture</h3>
<p><img src="/images/2019-05-16-OSLog/architecture.png" width="100%" /></p>

<h3 id="type-formatters">Type Formatters</h3>
<p><img src="/images/2019-05-16-OSLog/type_formatter.png" width="100%" /></p>

<h2 id="parameter-privacy">Parameter Privacy</h2>
<p>Privacy is handled on a parameter by parameter basis
<code class="highlighter-rouge">Scalars</code> and <code class="highlighter-rouge">Static strings</code> are assumed to be public
<code class="highlighter-rouge">Dynamic strings</code>, <code class="highlighter-rouge">collections</code> and <code class="highlighter-rouge">objects</code> are assumed to be private</p>

<h2 id="demo">Demo</h2>
<p>Here is the changing :</p>

<p><img src="/images/2019-05-16-OSLog/log_message_ex.png" width="100%" /></p>

<h2 id="activity-api-improvements">Activity API Improvements</h2>
<p>Activites are not objects that can be stored and re-used</p>
<ul>
  <li>Direct control of activity relationships during creation</li>
</ul>

<p>New API to auto-scope activites within the code</p>

<p><img src="/images/2019-05-16-OSLog/activity_example.png" width="100%" /></p>

<h2 id="tools">Tools</h2>

<h3 id="console">Console</h3>
<ul>
  <li>View live content form a system</li>
  <li>Open log archives</li>
  <li>New Activity centric view of logging and tracing</li>
  <li>Advanced filtering and searching</li>
  <li>Device support</li>
</ul>

<h3 id="log-command-line-tool">log Command Line Tool</h3>
<p><img src="/images/2019-05-16-OSLog/log_system_console.png" width="100%" /></p>

<h2 id="logging-etiquette">Logging Etiquette</h2>
<ul>
  <li>Ensure messages contain only information useful for debugging</li>
  <li>Leverage built-in formatters</li>
  <li>Avoid creating wrapper functions for <code class="highlighter-rouge">os_log</code> APIs</li>
  <li>Log only what you need from collections (Dictionaries, Arrays, etc)</li>
  <li>Avoid logging in tight code loops</li>
</ul>

<h2 id="suggest">Suggest</h2>
<ul>
  <li>Use <code class="highlighter-rouge">os_log</code> to log critical details to help debug issues</li>
  <li>Use <code class="highlighter-rouge">os_log_info</code> for additional info that will be captured during error or fault</li>
  <li>Use <code class="highlighter-rouge">os_log_debug</code> for high-volume debugging during development</li>
  <li>Use <code class="highlighter-rouge">os_log_error</code> to cause additional information capture from app</li>
  <li>Use <code class="highlighter-rouge">os_log_fault</code> to cause additional information capture from system</li>
</ul>

<h2 id="using-sysdiagnose">Using <code class="highlighter-rouge">sysdiagnose</code></h2>
<p><code class="highlighter-rouge">sysdiagnose</code> is the preferred method to capture data for bug reports</p>
<ul>
  <li>Unified logging data in <code class="highlighter-rouge">system_logs.archive</code></li>
</ul>

<p>Use <code class="highlighter-rouge">key-chord</code> to trigger
<code class="highlighter-rouge">sysdiagnose</code> on Apple Watch will trigger on both Apple Watch and iPhone
Transfer from device using iTunes</p>

<p>Here are some <code class="highlighter-rouge">key-chord</code>s</p>

<p><img src="/images/2019-05-16-OSLog/key_chords.png" width="100%" /></p>

<h1 id="measure-performance">Measure Performance</h1>

<h2 id="os_signpost"><code class="highlighter-rouge">os_signpost</code></h2>
<p>Instruments can take the data that <code class="highlighter-rouge">signposts</code> produce and you could check what your program is doing.</p>

<p>Here is an example:</p>

<p><img src="/images/2019-05-16-OSLog/os_signpost.png" width="100%" /></p>

<p><code class="highlighter-rouge">os_signpost</code> allows to mark the beginning and the end(<code class="highlighter-rouge">.begin</code> &amp; <code class="highlighter-rouge">.end</code>).</p>

<h2 id="measure-asynchronous-operation">Measure Asynchronous Operation</h2>
<ul>
  <li>Signpost Name</li>
  <li>Signpost ID – tell overlapping operations apart
  <img src="/images/2019-05-16-OSLog/signpost_id.png" width="100%" />
    <ul>
      <li>Making Signpost ID ()
  <img src="/images/2019-05-16-OSLog/make_signpost_id.png" width="100%" /></li>
      <li>process-scoped</li>
      <li>making from object is convenient if we have the same object at <code class="highlighter-rouge">.begin</code> and <code class="highlighter-rouge">.end</code></li>
      <li>Demo
  <img src="/images/2019-05-16-OSLog/signpost_id_ex.png" width="100%" /></li>
    </ul>
  </li>
</ul>

<h2 id="add-metadata-to-signpost">Add Metadata to Signpost</h2>
<ul>
  <li>Add context to the <code class="highlighter-rouge">.begin</code> and <code class="highlighter-rouge">.end</code></li>
  <li>Be able to pass arguments with <code class="highlighter-rouge">os_log</code> format string literal</li>
  <li>Pass many arguments with different types</li>
  <li>Pass dynamic strings</li>
</ul>

<h2 id="add-independent-event">Add Independent Event</h2>
<p><code class="highlighter-rouge">os_signpost</code> have <code class="highlighter-rouge">.event</code> type
Marking a single point</p>

<h2 id="conditionally-enable-signpost">Conditionally Enable Signpost</h2>
<p>Signposts are lightweight</p>
<ul>
  <li>Built to minimize observer effect</li>
  <li>Built for fine-grained measurement in a short time span</li>
</ul>

<p><code class="highlighter-rouge">OSLog.disabled</code></p>

<p><img src="/images/2019-05-16-OSLog/signpost_enable.png" width="100%" /></p>

<h2 id="instruments">Instruments</h2>
<ul>
  <li>Blank -&gt; add <code class="highlighter-rouge">os_signpost</code></li>
  <li>Able to retrieve from <code class="highlighter-rouge">Summary</code> part</li>
  <li>Able to <code class="highlighter-rouge">Record</code> the action</li>
</ul>

<h4 id="reference-link">Reference link</h4>
<ul>
  <li><a href="https://developer.apple.com/documentation/os/logging">Logging</a></li>
  <li><a href="https://developer.apple.com/videos/play/wwdc2016/721/">Unified Logging and Activity Tracing</a></li>
</ul>

  </div>
  <div class="colophon">
    <p>
      <span id="pub-date">Published on 14 May 2019</span> <span class="separator">&bull;</span>
      <span id="social">Find me on <a href="">Twitter</a>!</span>
    </p>
  </div>

  <!-- Add Disqus comments. -->
  <div id="disqus_thread"></div>
  <script src="/scripts/disqus.js" type="text/javascript"></script>
  <script id="dsq-count-scr" src="//hevawu-github-io.disqus.com/count.js" async></script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>


  </div>
  <script src="/scripts/responsive.js" type="text/javascript"></script>
</body>

</html>